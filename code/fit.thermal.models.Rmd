---
title: "Fit Thermal Models"
author: "Michael Gilchrist"
date: date: "`r Sys.time()`"
output: pdf_format
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Goal

- Fit series of thermal models found in `rTPC` to data collected in the Derryberry lab.
- Based on initial `.R` file created by Kayci Messerly `<messerlykayci1@gmail.com>`
- Intial analysis should be with GLM and mixture models.



# Set up

## Install libraries

```{r}
## install packages user might not have by replacing FALSE with TRUE
if(FALSE) {
    install.packages(c("RSQLite", "nls.multstart"))
    ##  Install the thermal curve package from git_hub, not cran
    remotes::install_github("padpadpadpad/rTPC")
}

## load libraries
library(RSQLite)  #not sure why we need this
library(rTPC)
library(nls.multstart)
library(broom)
library(tidyverse)
require(ggplot2)
require(GGally)
require(reshape2)
require(lme4)
require(RVAideMemoire) # provides overdisp.glmer()
require(MASS) # provides negative binomial fitting:  glm.nb
```

## Load Data

```{r}

## Read in ZEFI Data sets
## Treat 'repeatability' as round = 0
## Add round info

## Repeatability was done between round 1 and 2, female was present, but only one temp. so treating as `round = 2` and redefining `round = 2` as `round = 3`

data_raw = list()

data_raw[[1]] <- read.csv(file.path("..", "data", "raw_data", "HSPi-Repeatability-Song-Count.csv")) %>% mutate(round = 2)
data_raw[[2]] <- read.csv(file.path("..", "data", "raw_data", "HSPi-Round-1-Heat-Trials.csv")) %>% mutate(round = 1) ## Note T237 and T230 are missing numbers in the song_count column
data_raw[[3]] <-read.csv(file.path("..", "data", "raw_data", "HSPi-Round-2-Heat-Trials.csv")) %>% mutate(round = 3)

## Join data and discard empty columns
data_full <- full_join(data_raw[[1]], data_raw[[2]]) %>%
    full_join(data_raw[[3]]) %>%
    discard(~all(is.na(.) | . =="")) %>% ## get rid of columns of only NA
    mutate(trial_completed = !(is.na(song_count)) ) %>%
    mutate(song_count = ifelse(is.na(song_count), 0, song_count)) %>%
    mutate(song_count = song_count*1.0) %>% ## convert to a double so it's not treated as an integer
    rename(trial_order = test_order) %>%
    mutate(chamber = as.factor(chamber), male = as.factor(male)) %>%
    mutate(trial_order = ordered(trial_order)) %>%
    mutate() ## Dummy function so we can comment out lines above it w/o any issues


## Create a database
## Don't see where myConn this is used anywhere else

if(FALSE){
    db_data <- c(data_raw[[1]], data_raw[[2]], data_raw[[3]])
    ZEFI_DB <-"portalR.db"
    myConn <-dbConnect(drv = SQLite(), dbname=ZEFI_DB)

    dbListTables(myConn)

    if(!file.exists(ZEFI_DB))
    {
    dbWriteTable(myConn, "repeatability", data_raw[0])
    dbWriteTable(myConn, "data_raw1", data_raw1)
    dbWriteTable(myConn, "data_raw2", data_raw2)
    dbListTables(myConn)
    }
}

```

# Analysis


## Examine Data

```{r}

data <- data_full #%>% filter(round ==3)

data %>% group_by(temp_target) %>%
    filter(song_count < 400) %>%
    summarize(ave = mean(song_count), sd = sd(song_count), n = length(song_count), n_completed = sum(trial_completed))

data %>% 

```

## Poisson on `trial_completed`

- Only NA's are in highest temp.

## GLM on Song Rate

- See [webpage](https://stats.oarc.ucla.edu/r/faq/random-coefficient-poisson-models/)
  for mixed-effects poisson models
  
```{r}

data <- data_full %>% filter(round ==3)

model <- list()

## chamber seems unimportant, while trial_order and male are very important
## Data is very overdispersed given poisson assumptions
model$glm_poisson <- glm(song_count ~ 1+ male + trial_order + temp_target + I(temp_target^2), data = data, family = poisson(link = "log"))

## This allows for over dispersion which greatly elevates the SE
model$glm_qpoisson <- glm(model$glm_poisson, family = quasipoisson(link = "log"))

## Gives similar results as with the quasipoisson
model$glm_nb <- glm.nb(model$glm_poisson)


model$glmer_poisson <- glmer(
## song_count ~ 1 + chamber + (1|male) + (temp_target|male) + (I(temp_target^2)|male),
    song_count ~ 1 + trial_order + ((1 + temp_target + I(temp_target^2))|male),
    data = data,
    family = poisson(link = "log"),
    control = glmerControl(optCtrl = list(maxiter = 300)),
    verbose = TRUE)

## Still a lot of overdispersion
model$glmer_od <- overdisp.glmer(model$glmer_poisson)

## I think this is a correct fit.  If I don't include the 1 + temp... w/o the |male, I don't get any effects.
model$glmer_nb_1 <- glmer.nb(
    song_count ~ 1 + temp_target + I(temp_target^2) + trial_order + ((1 + temp_target + I(temp_target^2))|male),
    data = data,
    family = poisson(link = "log"),
    control = glmerControl(optCtrl = list(maxiter = 300)),
    verbose = TRUE)


model$glmer_nb_2 <- update(model$glmer_nb_1, formula =  song_count ~ 1 + temp_target + I(temp_target^2) + ((1 + temp_target + I(temp_target^2))|male) )

mode
```





## For Later: Lactin2 



```{r}

data <- data_full %>% filter(round ==3)

data %>% group_by(temp_target) %>%
    filter(song_count < 400) %>%
    summarize(ave = mean(song_count, na.rm = TRUE), sd = sd(song_count, na.rm = TRUE)) 


## show the data
## windows()
ggplot(data, aes(temp_target, song_count)) + 
    geom_point() +
    geom_jitter() +
  theme_bw(base_size = 12) +
  labs(x='Temperature (C)', 
       y='Song Count', 
       title = 'Song Count Across Temperature')

## choose the model
mod = 'lactin2_1995'

## get starting values
start_vals <- get_start_vals(data$temp_target, data$song_count, model_name = 'lactin2_1995')
  
## Get limits
low_lims <- get_lower_lims(data$temp_target,data$song_count,model_name = 'lactin2_1995')
upper_lims <- get_upper_lims(data$temp_target, data$song_count, model_name = 'lactin2_1995')

start_vals
low_lims
upper_lims
  
## fit model
fit <- nls_multstart(song_count~lactin2_1995(temp = temp_target, a,b,tmax,delta_t),
                                  data = data,
                                  iter = 600,
                                  start_lower = start_vals-10,
                                  start_upper = start_vals+10,
                                  lower = low_lims,
                                  upper = upper_lims,
                                  supp_errors = 'Y',
                                  convergence_count = FALSE)
  
## look at model fit
summary(fit)

## Predict new data 
preds <- data.frame(temp = seq(min(data$temp_target), max(data$temp_target), length.out = 6))
preds <- broom::augment(fit, newdata = preds)

## plot data and model fit
## windows()
ggplot(preds)+
  geom_point(aes(temp_target,song_count), data)+
  geom_line(aes(temp, .fitted), preds, col = 'blue')+
  theme_bw()+
  labs(x='Temperature (C)',
       y='Song Count',
       title = 'Song Count Across Temperatures')


```


## Unweighted model

- Fit 4 Chosen model formulations in rTPC


```{r}

d <-filter(heat_roundt2, Male =="T236")
d_fits <- nest(d, data = c(temp_target,song_count)) %>%
  mutate(lactin = map(data,~nls_multstart(song_count~lactin2_1995(temp = temp_target, a, b, tmax, delta_t),
                      data = .x,
                      iter = c(3,3,3,3),
                      start_lower = get_start_vals(.x$temp_target, .x$song_count, model_name = 'lactin2_1995')-10,
                      start_upper = get_start_vals(.x$temp_target, .x$song_count, model_name = 'lactin2_1995')+10,
                      lower = get_lower_lims(.x$temp_target, .x$song_count, model_name = 'lactin2_1995'),
                      upper= get_upper_lims(.x$temp_target, .x$song_count, model_name = 'lactin2_1995'),
                      supp_errors = 'Y',
                      convergence_count = FALSE)),
weibull = map(data,~nls_multstart(song_count~weibull_1995(temp = temp_target, a, topt, b,c),
                                  data = .x,
                                  iter = c(4,4,4,4),
                                  start_lower = get_start_vals(.x$temp_target, .x$song_count, model_name = 'weibull_1995')-10,
                                  start_upper = get_start_vals(.x$temp_target, .x$song_count, model_name = 'weibull_1995')+10,
                                  lower = get_lower_lims(.x$temp_target, .x$song_count, model_name = 'weibull_1995'),
                                  upper= get_upper_lims(.x$temp_target, .x$song_count, model_name = 'weibull_1995'),
                                  supp_errors = 'Y',
                                  convergence_count = FALSE)),
modifiedgaussian = map(data, ~nls_multstart(song_count~modifiedgaussian_2006(temp = temp_target, rmax,topt, a, b),
                                            data = .x,
                                            iter = c(3,3,3,3),
                                            start_lower = get_start_vals(.x$temp_target, .x$song_count, model_name = 'modifiedgaussian_2006')-10,
                                            start_upper = get_start_vals(.x$temp_target, .x$song_count, model_name = 'modifiedgaussian_2006')+10,
                                            lower = get_lower_lims(.x$temp_target, .x$song_count, model_name = 'modifiedgaussian_2006'),
                                            upper= get_upper_lims(.x$temp_target, .x$song_count, model_name = 'modifiedgaussian_2006'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)),
briere = map(data,nls_multstart(song_count~briere2_1999(temp = temp_target, tmin, tmax, a,b),
                                data = .x,
                                iter = c(4,4,4,4),
                                start_lower = get_start_vals(.x$temp_target, .x$song_count, model_name = 'briere2_1999')-10,
                                start_upper = get_start_vals(.x$temp_target, .x$song_count, model_name = 'briere2_1999')+10,
                                lower = get_lower_lims(.x$temp_target, .x$song_count, model_name = 'briere2_1999'),
                                upper= get_upper_lims(.x$temp_target, .x$song_count, model_name = 'briere2_1999'),
                                supp_errors = 'Y',
                                convergence_count = FALSE)))
