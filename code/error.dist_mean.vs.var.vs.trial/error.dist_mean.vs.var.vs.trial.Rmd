---
title: "Evaluate How `song_count` changes with trial at 40C"
author: "Michael Gilchrist"
date: "date: 2022-10-20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = TRUE, # show warnings
  message = TRUE, # show messages
  error = TRUE, # do not interrupt generation in case of errors,
  echo = TRUE  # show R code
  )


if(interactive()) default::default(.ess.eval) <- list(max.deparse.length=1E5, output = TRUE)

```
# Goal

- Evaluate trends in song_count under a (near) constant temperature.

# Set up

## Load libraries

```{r}


## load libraries
library(stats)
require(MASS) # provides negative binomial fitting:  glm.nb
library(RSQLite)  # Don't think we need this.
library(rTPC)  ## 
library(nls.multstart)
library(broom)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(grid) ## provides textGrob
library(gridExtra)
library(viridisLite)

#options(ggplot2.continuous.colour="viridis",
#        ggplot2.discrete.colour="viridis",
#        ggplot2.scale_fill_discrete = scale_fill_viridis_d,
#        ggplot2.scale_fill_continuous = scale_fill_viridis_c)

library(GGally)
library(reshape2)
library(lme4)
library(rsample) ## provides bootstraps()

library(RVAideMemoire) # provides overdisp.glmer()
library(humidity) ## provides VPD
library(weathermetrics)
library(latex2exp)

## Get stat_smooth_function
source_gist("524eade46135f6348140")
```

## Load Data

```{r}

## Read in ZEFI Data sets
## Treat 'repeatability' as round = 0
## Add round info

## Repeatability was done between round 1 and 2, female was present, but only one temp. so treating as `round = 2` and redefining `round = 2` as `round = 3`

git_root <- system("git rev-parse --show-toplevel", intern = TRUE)

data_raw = list()

data_raw[[1]] <- read.csv(file.path(git_root, "data", "raw_data", "HSPi-Round-1-Heat-Trials.csv")) %>% mutate(round = 1) %>%
    ## Note T237 and T230 are missing numbers in the song_count column
    ## so we are filtering these observations out until they are found
    filter(!is.na(song_count))

data_raw[[2]] <- read.csv(file.path(git_root, "data", "raw_data", "HSPi-Repeatability-Song-Count.csv")) %>%
    mutate(round = 2) %>%
    ungroup()

data_raw[[3]] <-read.csv(file.path(git_root, "data", "raw_data", "HSPi-Round-2-Heat-Trials.csv")) %>%
    mutate(round = 3) %>%
    ## Deal with missing temp_mean and humidity_mean values
    ## in round == 3
    ## 2022/10/19 - code no longer needed
    ## group_by(temp_target) %>% 
    ##mutate(temp = if_else((round == 3 & is.na(temp_mean)),
    ##                      mean(temp_mean, na.rm = TRUE),
    ##                      temp_mean)) %>%
    ##mutate(humidity = if_else((round == 3 & is.na(humidity_mean)),
    ##                          mean(humidity_mean, na.rm = TRUE),
    ##                          humidity_mean)) %>%
    ungroup() 


## Join data and discard empty columns
data_full <- full_join(data_raw[[1]], data_raw[[2]]) %>%
    full_join(data_raw[[3]]) %>%
    discard(~all(is.na(.) | . =="")) %>% ## get rid of columns of only NA
    mutate(trial_completed = !(is.na(song_count)) ) %>%
    mutate(song_count = ifelse(is.na(song_count), 0, song_count)) %>%
    mutate(song_count = song_count*1.0) %>% ## convert to a double so it's not treated as an integer
    mutate(chamber = as.factor(chamber), male = as.factor(male)) %>%
    ## create a male specific round and global trial index `trial`
    group_by(male, round) %>%
    mutate(trial_round = rank(date)) %>%
    ungroup(round) %>% 
    mutate(trial = rank(date)) %>%
    ungroup() %>%
    mutate(song_count_plus_1 = (song_count + 1)) %>%
    mutate(log_song_count_plus_1 = log(song_count + 1)) %>%
    mutate(temp_target = as.numeric(temp_target)) %>%
    ## Create generic 'temp' column which is either
    ## temp_mean, if it exists, or temp_target, if it doesn't
    mutate(temp = if_else(is.na(temp_mean),
                          temp_target,
                          temp_mean)) %>%
    ## Add column with total song_count for a given round
    group_by(male, round) %>%
    mutate(count_total_round = sum(song_count)) %>%
    ungroup() %>%
    mutate(song_prop = song_count/count_total_round) %>%
    ## assuming poisson error
    ## From glm man page
    ## > Non-‘NULL’ ‘weights’ can be used to indicate that different
    ## >  observations have different dispersions (with the values in
    ## >  ‘weights’ being inversely proportional to the dispersions);
    ## add +1 to deal with single 0
    ## Interpret dispersion as ~sd() or se() not var()
    mutate(count_wt = sqrt(1/(song_count + 1))) %>%
    ## need to rescale wts for song_prop data
    mutate(prop_wt = count_wt * count_total_round) %>% 
    ## Add vpd 
    mutate(svp = SVP(t = temp_mean + 273.15, isK = TRUE), vpd = svp*(1-humidity_mean/100) ) %>%
    group_by(round) %>%
    mutate(vpd_offset = vpd - mean(vpd)) %>%
    ungroup() %>%
    relocate(song_count, song_prop, vpd, temp_mean, humidity_mean, .after = male) %>% 
    mutate() ## Dummy function so we can comment out lines above it w/o any issues


```


# Examine Data

## Create Working Dataset

```{r}

data_ind <- data_full %>%
#    filter(round %in% c(2,3)) %>%
#    filter(count_total_round >= 1) %>%
    mutate()

## copy data frame and assign `male =  "combined")
data_comb <- data_ind %>% mutate(male = "combined")

data <- bind_rows(data_ind, data_comb)

```

## Examine How Var and Mean change with Trial using `temp_target = 40`

```{r}

data_40  <- data_ind %>%
    filter(temp_target == 40) %>%
    unique()

dim(data_40)

stats_40 <- data_40 %>%
    group_by(male) %>%
    summarize(mean = mean(song_count), var = var(song_count, na.rm = TRUE), count = length(song_count)) %>% mutate(round = 0)
stats_40

var_threshold <- 7500

male_high_var <- stats_40 %>% filter(var > var_threshold) %>% pull(male)
data_male_high_var <- data_40 %>% filter(male %in% male_high_var)

ggplot(data_male_high_var) +
    aes(x=song_count,
        color = male,
        fill = male) + 
    geom_histogram() +
    labs(title = paste0("Data for males with exceptionally high variances", paste(male_high_var, collapse = " & "))
         )

## We have 5 birds that have only 1 observation.

song_stats <- filter(raw_stats_40, !is.na(var))
song_stats


for(filter_high_var in c(FALSE, TRUE)){

    data_tmp <- data_40
    song_stats_tmp <- song_stats
    
    if(filter_high_var){
        data_tmp <- filter(data_tmp, !(male %in% male_high_var) )
        song_stats_tmp <- filter(song_stats_tmp, !(male %in% male_high_var) )
    }
    
g1 <- ggplot(data_tmp) +
    aes(x=song_count,
        color = male,
        fill = male) + 
    geom_histogram() +
    labs(title = "Raw Count Data")

g2 <- ggplot(song_stats_tmp) +
    aes(x=mean, y = var) + 
    geom_point(aes(color = male)) +
    geom_smooth(method='lm', formula= y~x) +
    ## from source_gist("524eade46135f6348140")
    stat_smooth_func(geom="text",method="lm",hjust=0,parse=TRUE) +
    labs(title = "Mean vs. var for all rounds: temp_target = 40")

g3 <- ggplot(song_stats_tmp) +
    aes(x=mean, y = var) +
    geom_point(aes(color = male)) +
    geom_smooth(method='lm', formula= y~x) +
    stat_smooth_func(geom="text",method="lm",hjust=0,parse=TRUE) +
    labs(title = "Mean vs. Var for all rounds: temp_target = 40",
         subtitle = "log(var) ~ log(mean)") + 
    scale_x_log10() +
    scale_y_log10()
    
#ggcoefstats(

    formula <- y ~ -1 + x+I(x^2)
    
g4 <- ggplot(song_stats_tmp) +
    aes(x=mean, y = var) +
    geom_point(aes(color = male)) +
    geom_smooth(method='glm', formula = formula) +
    stat_smooth_func(geom="text",method="lm", formula = formula, hjust=0,parse=TRUE) +
    labs(title = "Mean vs. Var for all rounds: temp_target = 40",
         subtitle = "var ~ mean + mean^2")
#    scale_x_log10() +
#    scale_y_log10()

    dev.new()
    grid.arrange(g1, g2, g3, g4,
                 ncol=2,
                 top=textGrob(paste0("Mean vs. Var: Filter High Var = ", filter_high_var))
                 )

}

```

## Compare Rounds 2 and 3

```{r}

count_total_round_2_and_3  <- data_ind %>%
    select(c(male, count_total_round, round)) %>%
    unique() %>%
    pivot_wider(names_from = "round", values_from = "count_total_round")%>%
    select(male, `2`, `3`) %>%
    print(n=100)

```

## Rounds 2 and 3 vs Temp

```{r}


xlab <- "Temperature"
ylab <- "song_count"

plot_temp_data <-
    ggplot(data) + 
    aes(x = temp,
        y = song_count) +
    facet_wrap("male", scales = "free_y") +
    geom_point() +
labs( title = paste( ylab, " vs ", xlab))
last_plot()


pivot_wider(data_ind, names_from = "round", values_from = "count_total_round") %>% select(male, `2`, `3`) %>% filter(!is.na(`3`)) %>% unique()

```


## Formal Model Fits to `song_count`


Using

- `x = temp -45C`
- use `offset(log(count_total_round))` instead of `male` as a factor

```{r}

temp_ref <- 45
verbose <- 0
trace <- FALSE

## Try filtering the data a bit more
## Goal is to get good starting values

data <- data_ind %>%
    mutate(x1 = (temp - temp_ref)) %>%
    filter(
    (round == 3 & count_total_round >= 400) |
    (round == 2 & count_total_round > 30)
    ) %>%
    mutate() %>%
#    filter( !(male %in% c("T231", "T260"))) %>% 
    mutate()

make_plot = TRUE;

glm_poisson_1 <- glm(song_count ~
                       (1 + male  +  (x1) + I(x1^2)),
                   data = data,
                   family = poisson(link = "log")
                   )

summary(glm_poisson_1)

## Add round effect
glm_poisson_2 <- glm(song_count ~
                       (1 + male + round +  (x1) + I(x1^2)),
                   data = data,
                   family = poisson(link = "log")
                   )
## Results support round effect
summary(glm_poisson_2)

male_coef <-  coef(glm_poisson_2) %>% keep(str_detect(names(.), 'male'))

hist(male_coef, breaks = 30)

## Remove male effect
glm_poisson_3 <- glm(song_count ~
                       (1 + round +  (x1) + I(x1^2)),
                   data = data,
                   family = poisson(link = "log")
                   )
## Note that using qpoisson doesn't affect MLE

summary(glm_poisson_3)

if(make_plot){
    ifelse(length(dev.list()) < 3, {dev.new(); dev.next()}, dev.next())
    par(mfrow = c(2, 2))
    plot(glm_poisson_2, ask = FALSE)
    page_label <- "glm with poisson error"
    mtext(page_label, outer=TRUE,  cex=1, line=-1.1)
}

glm_qpoisson_1 <- update(glm_poisson_1,
                       family = quasipoisson(link = "log")
                       )
summary(glm_qpoisson_1)

if(make_plot){
    ifelse(length(dev.list()) < 3, dev.new(), dev.next())
    par(mfrow = c(2, 2))
    plot(glm_qpoisson_1, ask = FALSE)
    page_label <- "glm with poisson error"
    mtext(page_label, outer=TRUE,  cex=1, line=-1.1)
##    dev.new()
##    ggplot(data, aes(temp, song_count))
}

glm_qpoisson_2 <- update(glm_poisson_2,
                       family = quasipoisson(link = "log")
                       )
summary(glm_qpoisson_2)

if(make_plot){
    ifelse(length(dev.list()) < 3, dev.new(), dev.next())
    par(mfrow = c(2, 2))
    plot(glm_qpoisson_2, ask = FALSE)
    page_label <- "glm with poisson error"
    mtext(page_label, outer=TRUE,  cex=1, line=-1.1)
##    dev.new()
##    ggplot(data, aes(temp, song_count))
}


glm_qpoisson_3 <- update(glm_poisson_3,
                       family = quasipoisson(link = "log")
                       )
summary(glm_qpoisson_3)

if(make_plot){
    ifelse(length(dev.list()) < 3, dev.new(), dev.next())
    par(mfrow = c(2, 2))
    plot(glm_qpoisson_3, ask = FALSE)
    page_label <- "glm with poisson error"
    mtext(page_label, outer=TRUE,  cex=1, line=-1.1)
##    dev.new()
##    ggplot(data, aes(temp, song_count))
}

```

### Result

- Overdispersion of data makes parameters non-significant
- Don't how a `song_prop` approach will solve this issue.
  

